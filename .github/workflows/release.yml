name: Release

on:
  workflow_dispatch:
    inputs:
      release_type:
        description: "Semver bump type"
        required: true
        type: choice
        options:
          - patch
          - minor
          - major
      dry_run:
        description: "Dry run - build and sign but skip GitHub Release creation and version commit"
        required: false
        type: boolean
        default: false

permissions:
  contents: write

jobs:
  version:
    name: Bump Version
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.bump.outputs.version }}
      tag: ${{ steps.bump.outputs.tag }}
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4
        with:
          node-version: 22

      - name: Bump version
        id: bump
        run: |
          CURRENT=$(node -p "require('./package.json').version")
          IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT"

          case "${{ inputs.release_type }}" in
            major) MAJOR=$((MAJOR + 1)); MINOR=0; PATCH=0 ;;
            minor) MINOR=$((MINOR + 1)); PATCH=0 ;;
            patch) PATCH=$((PATCH + 1)) ;;
          esac

          NEW_VERSION="${MAJOR}.${MINOR}.${PATCH}"

          echo "tag=v${NEW_VERSION}" >> "$GITHUB_OUTPUT"
          echo "version=${NEW_VERSION}" >> "$GITHUB_OUTPUT"
          echo "Bumped $CURRENT -> $NEW_VERSION (${{ inputs.release_type }})"

  build:
    name: Build (${{ matrix.arch }})
    needs: version
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: true
      matrix:
        include:
          - arch: arm64
            runner: macos-latest
          - arch: x64
            runner: macos-13

    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4
        with:
          node-version: 22
          cache: npm

      - name: Apply version
        run: npm version "${{ needs.version.outputs.version }}" --no-git-tag-version

      - name: Install dependencies
        run: npm ci

      - name: Import code signing certificate
        env:
          CERTIFICATE_P12_BASE64: ${{ secrets.CERTIFICATE_P12_BASE64 }}
          CERTIFICATE_PASSWORD: ${{ secrets.CERTIFICATE_PASSWORD }}
        run: |
          # Decode the certificate
          CERTIFICATE_PATH="$RUNNER_TEMP/certificate.p12"
          echo "$CERTIFICATE_P12_BASE64" | base64 --decode > "$CERTIFICATE_PATH"

          # Create a temporary keychain
          KEYCHAIN_PATH="$RUNNER_TEMP/signing.keychain-db"
          KEYCHAIN_PASSWORD="$(openssl rand -hex 24)"

          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

          # Import the certificate into the keychain
          security import "$CERTIFICATE_PATH" \
            -P "$CERTIFICATE_PASSWORD" \
            -A \
            -t cert \
            -f pkcs12 \
            -k "$KEYCHAIN_PATH"

          # Allow codesign to access the keychain without UI prompt
          security set-key-partition-list \
            -S apple-tool:,apple:,codesign: \
            -s \
            -k "$KEYCHAIN_PASSWORD" \
            "$KEYCHAIN_PATH"

          # Add the keychain to the search list (prepend so it's found first)
          security list-keychains -d user -s "$KEYCHAIN_PATH" $(security list-keychains -d user | tr -d '"')

          echo "KEYCHAIN_PATH=$KEYCHAIN_PATH" >> "$GITHUB_ENV"

      - name: Prepare App Store Connect API key
        env:
          APPLE_API_KEY_BASE64: ${{ secrets.APPLE_API_KEY_BASE64 }}
          APPLE_API_KEY_ID: ${{ secrets.APPLE_API_KEY_ID }}
        run: |
          # notarytool expects the key at ~/private_keys/AuthKey_<ID>.p8
          mkdir -p ~/private_keys
          echo "$APPLE_API_KEY_BASE64" | base64 --decode > ~/private_keys/AuthKey_${APPLE_API_KEY_ID}.p8

      - name: Restore provisioning profile
        env:
          PROVISIONING_PROFILE_BASE64: ${{ secrets.PROVISIONING_PROFILE_BASE64 }}
        run: |
          mkdir -p build
          echo "$PROVISIONING_PROFILE_BASE64" | base64 --decode > build/Vox_Profile.provisionprofile

      - name: Build app
        run: npm run build

      - name: Package and sign (DMG + zip)
        env:
          CSC_KEYCHAIN: ${{ env.KEYCHAIN_PATH }}
          APPLE_API_KEY: ~/private_keys/AuthKey_${{ secrets.APPLE_API_KEY_ID }}.p8
          APPLE_API_KEY_ID: ${{ secrets.APPLE_API_KEY_ID }}
          APPLE_API_ISSUER: ${{ secrets.APPLE_API_ISSUER_ID }}
        run: npx electron-builder --mac dmg zip --${{ matrix.arch }} --publish never

      - name: Clean up keychain
        if: always()
        run: |
          if [ -f "$KEYCHAIN_PATH" ]; then
            security delete-keychain "$KEYCHAIN_PATH"
          fi

      - name: Rename artifacts
        run: |
          VERSION="${{ needs.version.outputs.version }}"
          ARCH="${{ matrix.arch }}"

          DMG=$(find out -name "*.dmg" -type f | head -1)
          ZIP=$(find out -name "*.zip" -type f | head -1)

          mv "$DMG" "out/Vox-${VERSION}-mac-${ARCH}.dmg"
          mv "$ZIP" "out/Vox-${VERSION}-mac-${ARCH}.zip"

      - name: Upload artifacts
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: vox-${{ needs.version.outputs.version }}-mac-${{ matrix.arch }}
          path: |
            out/*.dmg
            out/*.zip
          if-no-files-found: error

  release:
    name: Publish Release
    needs: [version, build]
    if: ${{ !inputs.dry_run }}
    runs-on: ubuntu-latest

    steps:
      - name: Generate app token
        id: app-token
        uses: actions/create-github-app-token@d72941d797fd3113feb6b93fd0dec494b13a2547 # v1
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}

      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
        with:
          token: ${{ steps.app-token.outputs.token }}

      - uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4
        with:
          node-version: 22
          cache: npm

      - name: Download all artifacts
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4
        with:
          path: artifacts
          pattern: vox-*-mac-*

      - name: Prepare release assets
        run: |
          VERSION="${{ needs.version.outputs.version }}"
          mkdir -p release

          # Move versioned artifacts to release directory
          find artifacts -type f \( -name "*.dmg" -o -name "*.zip" \) -exec mv {} release/ \;

          # Create stable-named copies for the latest release
          cp "release/Vox-${VERSION}-mac-arm64.dmg" "release/Vox-mac-arm64.dmg"
          cp "release/Vox-${VERSION}-mac-arm64.zip" "release/Vox-mac-arm64.zip"
          cp "release/Vox-${VERSION}-mac-x64.dmg"   "release/Vox-mac-x64.dmg"
          cp "release/Vox-${VERSION}-mac-x64.zip"    "release/Vox-mac-x64.zip"

          ls -lh release/

      - name: Commit version bump
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
        run: |
          npm version "${{ needs.version.outputs.version }}" --no-git-tag-version
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add package.json package-lock.json
          git commit -m "chore(release): bump version to ${{ needs.version.outputs.version }}"
          git push origin HEAD:main

      - name: Create versioned GitHub Release
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
        run: |
          VERSION="${{ needs.version.outputs.version }}"
          TAG="${{ needs.version.outputs.tag }}"

          git tag "$TAG"
          git push origin "$TAG"

          gh release create "$TAG" \
            --title "Vox $TAG" \
            --generate-notes \
            "release/Vox-${VERSION}-mac-arm64.dmg" \
            "release/Vox-${VERSION}-mac-arm64.zip" \
            "release/Vox-${VERSION}-mac-x64.dmg" \
            "release/Vox-${VERSION}-mac-x64.zip"

          echo "Versioned release created: $TAG"

      - name: Update latest release
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
        run: |
          TAG="${{ needs.version.outputs.tag }}"

          # Delete existing latest release and tag if they exist
          gh release delete latest --yes 2>/dev/null || true
          git push origin :refs/tags/latest 2>/dev/null || true

          # Create new latest tag pointing to current commit
          git tag -f latest
          git push origin latest

          # Create the latest release with stable-name assets
          gh release create latest \
            --title "Vox Latest ($TAG)" \
            --notes "$(cat <<'NOTES'
          This release always points to the latest version. Current: **$TAG**

          ### Download

          **Apple Silicon (M1/M2/M3/M4):**
          - [Vox-mac-arm64.dmg](https://github.com/app-vox/vox/releases/download/latest/Vox-mac-arm64.dmg)
          - [Vox-mac-arm64.zip](https://github.com/app-vox/vox/releases/download/latest/Vox-mac-arm64.zip)

          **Intel:**
          - [Vox-mac-x64.dmg](https://github.com/app-vox/vox/releases/download/latest/Vox-mac-x64.dmg)
          - [Vox-mac-x64.zip](https://github.com/app-vox/vox/releases/download/latest/Vox-mac-x64.zip)
          NOTES
          )" \
            release/Vox-mac-arm64.dmg \
            release/Vox-mac-arm64.zip \
            release/Vox-mac-x64.dmg \
            release/Vox-mac-x64.zip

          echo "Latest release updated"
